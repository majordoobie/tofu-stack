'use strict';const a15k=a15b;(function(a,b){const j=a15b,c=a();while(!![]){try{const d=-parseInt(j(0x137))/0x1*(-parseInt(j(0x132))/0x2)+-parseInt(j(0x19a))/0x3+-parseInt(j(0x119))/0x4*(parseInt(j(0x147))/0x5)+parseInt(j(0x12b))/0x6*(-parseInt(j(0x18b))/0x7)+parseInt(j(0x167))/0x8*(-parseInt(j(0x151))/0x9)+-parseInt(j(0x177))/0xa*(parseInt(j(0x11f))/0xb)+parseInt(j(0x148))/0xc*(parseInt(j(0x128))/0xd);if(d===b)break;else c['push'](c['shift']());}catch(e){c['push'](c['shift']());}}}(a15a,0xb7069));var __createBinding=this&&this[a15k(0x18e)]||(Object[a15k(0x150)]?function(a,b,c,d){const l=a15k;if(d===undefined)d=c;var e=Object['getOwnPropertyDescriptor'](b,c);(!e||('get'in e?!b[l(0x186)]:e[l(0x12f)]||e[l(0x15b)]))&&(e={'enumerable':!![],'get':function(){return b[c];}}),Object[l(0x187)](a,d,e);}:function(a,b,c,d){if(d===undefined)d=c;a[d]=b[c];}),__setModuleDefault=this&&this[a15k(0x17b)]||(Object[a15k(0x150)]?function(a,b){const m=a15k;Object[m(0x187)](a,m(0x133),{'enumerable':!![],'value':b});}:function(a,b){const n=a15k;a[n(0x133)]=b;}),__importStar=this&&this[a15k(0x185)]||function(a){const o=a15k;if(a&&a[o(0x186)])return a;var b={};if(a!=null){for(var c in a)if(c!==o(0x133)&&Object[o(0x17f)][o(0x13d)]['call'](a,c))__createBinding(b,a,c);}return __setModuleDefault(b,a),b;},__importDefault=this&&this[a15k(0x141)]||function(a){const p=a15k;return a&&a[p(0x186)]?a:{'default':a};};Object[a15k(0x187)](exports,a15k(0x186),{'value':!![]}),exports[a15k(0x118)]=exports[a15k(0x182)]=exports[a15k(0x117)]=void 0x0;const fs_1=__importStar(require('fs')),os_1=__importDefault(require('os')),path_1=__importDefault(require('path')),childProcess=require(a15k(0x11c)),configStr=process[a15k(0x163)][0x2],configObj=JSON['parse'](configStr),{launchExeDir,launchExePath,logPathDir,appsDir,config,toDeletePath,action,killAllProcessesDuringUpdate,signalFilePath,inDocker}=configObj,logFilePath=logPathDir+'/'+config['name']+a15k(0x142),updaterLogPrefix=a15k(0x15c),basicLogger=(a,b)=>{const q=a15k,c=new Date(),d=''+c[q(0x16f)]()+('-'+String(c[q(0x129)]()+0x1)[q(0x19b)](0x2,'0'))+('-'+String(c['getDate']())[q(0x19b)](0x2,'0'))+'T'+(''+String(c[q(0x159)]())[q(0x19b)](0x2,'0'))+(':'+String(c[q(0x192)]())['padStart'](0x2,'0'))+(':'+String(c['getSeconds']())[q(0x19b)](0x2,'0'))+('.'+String(c['getMilliseconds']())[q(0x19b)](0x3,'0')),e='['+d+']\x20['+a+']\x20'+updaterLogPrefix+'\x20'+b;console[q(0x180)](e);try{fs_1[q(0x133)][q(0x13b)](logFilePath,e+'\x0a');}catch(f){console[q(0x15f)](q(0x155)+f);}},logger={'info':a=>basicLogger(a15k(0x16d),a),'error':a=>basicLogger(a15k(0x178),a)};function a15a(){const I=['appendFileSync','.exe\x22\x202>NUL\x20|\x20find\x20/I\x20/N\x20\x22','hasOwnProperty','down','Failed\x20to\x20rename\x20\x22','Created\x20signal\x20file:\x20','__importDefault','_Log.txt','In\x20Docker:\x20bringing\x20s6\x20service\x20back\x20up\x20after\x20update','Hash\x20verification\x20failed','Killing\x20all\x20processes\x20before\x20file\x20swap\x20to\x20avoid\x20file\x20locks','/tmp/tdarr_s6_down_','34675dmwejv','45268788nMXuym','lstat','\x20attempt(s)','includes','Restarting\x20with\x20new\x20version,\x20waiting\x20for\x20tray\x20to\x20exit','Renamed\x20\x22','name','Tdarr_Server','create','66879chEkXk','Unable\x20to\x20create\x20file\x20\x22','Copied\x20\x22','Failed\x20to\x20move\x20new\x20version,\x20rolling\x20back','Error\x20writing\x20to\x20log\x20file:\x20','access','isDirectory','File\x20did\x20not\x20become\x20executable,\x20attempting\x20to\x20launch\x20anyway','getHours','Old\x20hash:\x20','configurable','[SelfUpdate]','.exe\x22>NUL','split','error','Tray\x20exe\x20not\x20found,\x20using\x20non-tray\x20exe:\x20\x22','Process\x20','Killing\x20all\x20processes','argv','spawn','Hashes\x20match,\x20copy\x20verified','writeFile','16CblNUU','unlink','execSync','find\x20\x22','info','Copy\x20failed,\x20cleaning\x20up\x20partial\x20copy:\x20','INFO','\x22,\x20error:\x20','getFullYear','tdarr_server','exit','Error\x20controlling\x20s6\x20service:\x20','\x20for\x20service:\x20','stringify','rmdir','dirname','102020BKGvCR','ERROR','/tmp/tdarr_s6_up_','\x20signal\x20to\x20be\x20processed.\x20Monitor\x20service\x20may\x20not\x20be\x20running.','__setModuleDefault','F_OK','_New','Exe\x20does\x20not\x20exist,\x20cannot\x20launch:\x20\x22','prototype','log','Killed\x20all\x20processes','killAll','File\x20does\x20not\x20exist:\x20\x22','utf8','__importStar','__esModule','defineProperty','killall\x20','EXDEV','killall\x20-9\x20','5342113xrGPlH','_Runtime','Successfully\x20moved\x20using\x20copy+delete','__createBinding','\x20running,\x20killing','Restarting,\x20waiting\x20for\x20tray\x20to\x20exit','Failed\x20to\x20write\x20to\x20file\x20\x22','getMinutes','File\x20is\x20executable\x20after\x20','unref','function','\x22:\x20','Update\x20applied\x20successfully,\x20cleaning\x20up\x20old\x20version','tasklist\x20/FI\x20\x22IMAGENAME\x20eq\x20','chmod','1247337rzIrSF','padStart','Hash\x20verification\x20failed\x20after\x20','Error:\x20','\x20command\x20processed\x20successfully','code','Error\x20setting\x20permissions:\x20','\x22\x20-type\x20f\x20-exec\x20sha256sum\x20{}\x20+\x20|\x20cut\x20-d\x27\x20\x27\x20-f1\x20|\x20sort\x20|\x20sha256sum','execFileSync','New\x20hash\x20(attempt\x20','taskkill\x20/F\x20/IM\x20','Using\x20copy+delete\x20fallback\x20for\x20cross-device\x20move','Error\x20executing\x20update\x20and\x20launch\x20script:\x20','isWindows','killAllPre','480WbpfWw','update','Attempt\x20','child_process','Deleted\x20\x22','Renaming\x20\x22','1166TJCDrL','\x20attempts','mkdir','catch','Error\x20occurred,\x20bringing\x20s6\x20service\x20back\x20up','File\x20did\x20not\x20become\x20executable\x20after\x205\x20attempts:\x20\x22','\x22,\x20exiting...','_Tray','Launched\x20exe:\x20\x22','13OvQPsB','getMonth','Setting\x20executable\x20permissions\x20before\x20launch','6gefOtD','now','promises','tdarr_node','writable','Checking\x20if\x20file\x20is\x20executable:\x20\x22','taskkill\x20/IM\x20','526hEQEXN','default','Deleting\x20\x22','/5:\x20File\x20not\x20yet\x20executable,\x20waiting...','constants','322YzKliI','In\x20Docker:\x20bringing\x20down\x20s6\x20service\x20to\x20prevent\x20auto-restart','\x22\x20to\x20\x22','win32'];a15a=function(){return I;};return a15a();}process['on'](a15k(0x171),()=>{const r=a15k;logger[r(0x16b)]('Exiting');});const updaterLog=(a,b)=>{logger[a](b);},exists=async(a,b)=>{const s=a15k;try{return await fs_1[s(0x12d)][s(0x156)](a,fs_1[s(0x133)][s(0x136)][s(0x17c)]),!![];}catch(c){return b&&logger[s(0x15f)](s(0x183)+a+'\x22'),![];}},waitForPropagation=async a=>{const t=a15k;logger[t(0x16b)](t(0x130)+a+'\x22');for(let b=0x0;b<0x5;b+=0x1){try{return await fs_1[t(0x12d)][t(0x156)](a,fs_1[t(0x133)][t(0x136)]['X_OK']),logger[t(0x16b)](t(0x193)+(b+0x1)+t(0x14a)),!![];}catch(c){logger[t(0x16b)](t(0x11b)+(b+0x1)+t(0x135)),await new Promise(d=>setTimeout(d,0x3e8));}}return logger[t(0x15f)](t(0x124)+a+'\x22'),![];};exports[a15k(0x117)]=os_1[a15k(0x133)]['platform']()===a15k(0x13a);const tryCommand=a=>{const u=a15k;try{childProcess['execSync'](a);}catch(b){updaterLog('error',u(0x19d)+b);}},isProcessRunning=a=>{const v=a15k,b=exports[v(0x117)]?v(0x198)+a+v(0x13c)+a+v(0x15d):'pgrep\x20-x\x20'+a;try{return childProcess[v(0x169)](b),!![];}catch(c){return![];}},killAll=async(a,b)=>{const w=a15k;exports[w(0x117)]?(tryCommand(w(0x131)+b+'.exe'),await new Promise(c=>setTimeout(c,0x3e8)),(a||isProcessRunning(b))&&tryCommand(w(0x114)+b+'.exe')):(tryCommand(w(0x188)+b),await new Promise(c=>setTimeout(c,0x3e8)),isProcessRunning(b)&&tryCommand(w(0x18a)+b));};exports[a15k(0x182)]=killAll;const killAllPre=async a=>{const x=a15k;if(!isProcessRunning(a)){updaterLog(x(0x16b),x(0x161)+a+'\x20not\x20running');return;}updaterLog(x(0x16b),x(0x161)+a+x(0x18f)),await(0x0,exports['killAll'])(![],a);};exports[a15k(0x118)]=killAllPre;const killAllProcesses=async()=>{const y=a15k;await(0x0,exports[y(0x118)])(config[y(0x14e)]+y(0x18c)),await(0x0,exports['killAllPre'])(config[y(0x14e)]),await(0x0,exports[y(0x118)])(config[y(0x14e)]+y(0x126));},setS6=async a=>{const z=a15k;a===z(0x13e)?logger[z(0x16b)](z(0x138)):logger[z(0x16b)](z(0x143));const b=config['name']===z(0x14f)?z(0x170):z(0x12e),c=a===z(0x13e)?z(0x146)+b:z(0x179)+b;try{await fs_1[z(0x12d)]['writeFile'](c,b,'utf8'),logger[z(0x16b)](z(0x140)+c+z(0x173)+b);const d=0x2710,e=0x64;let f=0x0;while(await exists(c,![])&&f<d){await new Promise(g=>setTimeout(g,e)),f+=e;}await exists(c,![])?(logger[z(0x15f)]('Timeout\x20waiting\x20for\x20s6\x20'+a+z(0x17a)),await fs_1[z(0x12d)][z(0x168)](c)[z(0x122)](()=>{})):(logger['info']('s6\x20service\x20'+a+z(0x19e)),a===z(0x13e)&&await new Promise(g=>setTimeout(g,0x7d0)));}catch(g){logger[z(0x15f)](z(0x172)+g),await fs_1[z(0x12d)]['unlink'](c)['catch'](()=>{});}},runExe=async()=>{const A=a15k;let a=launchExePath;a[A(0x14b)]('_Tray')&&!await exists(a,!![])&&(logger[A(0x16b)](A(0x160)+a+'\x22'),a=a['replace'](A(0x126),''));if(!exports[A(0x117)])try{logger[A(0x16b)](A(0x12a)),childProcess[A(0x112)](A(0x199),['-R','+x',launchExeDir]),logger[A(0x16b)]('Executable\x20permissions\x20set,\x20waiting\x20for\x20propagation');const b=await waitForPropagation(a);!b&&logger[A(0x15f)](A(0x158));}catch(c){logger[A(0x15f)](A(0x1a0)+c);}(killAllProcessesDuringUpdate||inDocker)&&(inDocker&&await setS6(A(0x13e)),logger[A(0x16b)](A(0x162)),await killAllProcesses(),logger[A(0x16b)](A(0x181)));!await exists(a,!![])&&logger[A(0x15f)](A(0x17e)+a+'\x22');if(!inDocker){const d={'detached':!![],'stdio':'ignore','cwd':launchExeDir};logger[A(0x16b)]('Launching\x20exe:\x20\x22'+a+'\x22');try{const e=childProcess[A(0x164)](a,[],d);e['on']('error',f=>{const B=A;logger[B(0x15f)]('Failed\x20to\x20spawn\x20exe\x20\x22'+a+'\x22,\x20error:\x20'+f);}),e[A(0x194)](),await new Promise(f=>setTimeout(f,0x64)),logger[A(0x16b)](A(0x127)+a+'\x22');}catch(f){logger[A(0x15f)]('Error\x20spawning\x20exe\x20\x22'+a+A(0x196)+f);}}else await setS6('up');},tryUnlink=async(a,b)=>{const C=a15k;let c=0x0;while(c<b){try{if(!await exists(a,!![]))return!![];logger[C(0x16b)](C(0x134)+a+'\x22');const d=await fs_1[C(0x12d)][C(0x149)](a);return d[C(0x157)]()?typeof fs_1['promises']['rm']===C(0x195)?await fs_1['promises']['rm'](a,{'recursive':!![],'force':!![]}):await fs_1[C(0x12d)][C(0x175)](a,{'recursive':!![]}):await fs_1[C(0x12d)][C(0x168)](a),logger['info'](C(0x11d)+a+'\x22'),!![];}catch(e){logger[C(0x15f)]('Failed\x20to\x20delete\x20\x22'+a+C(0x16e)+e),c+=0x1,await new Promise(f=>setTimeout(f,0x7d0));}}return![];},getDirectoryHash=a=>{const D=a15k;try{const b=childProcess['execSync'](D(0x16a)+a+D(0x1a1),{'encoding':D(0x184)});return b[D(0x15e)]('\x20')[0x0];}catch(c){logger[D(0x15f)]('Error\x20calculating\x20directory\x20hash:\x20'+c);}return'';},tryCopyAndDelete=async(a,b)=>{const E=a15k;logger[E(0x16b)](E(0x115));try{const d=path_1['default'][E(0x176)](b);await fs_1['promises'][E(0x121)](d,{'recursive':!![]});let e='',f='';!exports['isWindows']&&(e=getDirectoryHash(a),logger[E(0x16b)](E(0x15a)+e));await fs_1[E(0x12d)]['cp'](a,b,{'recursive':!![],'preserveTimestamps':!![],'dereference':![]}),await new Promise(g=>setTimeout(g,0x3e8));if(!exports[E(0x117)]){let g=0x0;const h=0x14;while(e!==f){f=getDirectoryHash(b),logger[E(0x16b)](E(0x113)+(g+0x1)+'):\x20'+f);if(e===f){logger[E(0x16b)](E(0x165));break;}g+=0x1;if(g>=h){logger[E(0x15f)](E(0x19c)+h+E(0x120));throw new Error(E(0x144));}await new Promise(i=>setTimeout(i,0x1388));}}logger[E(0x16b)](E(0x153)+a+E(0x139)+b+'\x22');}catch(i){logger[E(0x15f)](E(0x16c)+i),await tryUnlink(b,0x1);throw i;}const c=await tryUnlink(a,0x5);if(!c)return logger[E(0x15f)]('Failed\x20to\x20delete\x20original\x20after\x20copy\x20-\x20manual\x20cleanup\x20required'),![];return logger[E(0x16b)](E(0x18d)),!![];},tryRename=async(a,b)=>{const F=a15k;logger[F(0x16b)](F(0x11e)+a+F(0x139)+b+'\x22');let c=0x0;while(c<0x5){try{return await fs_1[F(0x12d)]['rename'](a,b),logger[F(0x16b)](F(0x14d)+a+F(0x139)+b+'\x22'),!![];}catch(d){if(d[F(0x19f)]===F(0x189))try{return await tryCopyAndDelete(a,b);}catch(e){logger[F(0x15f)]('Copy+delete\x20failed:\x20'+e);}else logger[F(0x15f)](F(0x13f)+a+'\x22\x20to\x20\x22'+b+F(0x16e)+d);c+=0x1,await new Promise(f=>setTimeout(f,0x7d0));}}return![];},tryWriteFile=async(a,b)=>{const G=a15k;let c=0x0;while(c<0x5){try{return await fs_1[G(0x12d)][G(0x166)](a,b),!![];}catch(d){logger[G(0x15f)](G(0x191)+a+G(0x16e)+d),c+=0x1,await new Promise(e=>setTimeout(e,0x7d0));}}return![];},run=async()=>{const H=a15k;try{const a=await tryWriteFile(signalFilePath,'');!a&&(logger[H(0x15f)](H(0x152)+signalFilePath+H(0x125)),process[H(0x171)](0x1));logger['info'](action===H(0x11a)?H(0x14c):H(0x190)),await new Promise(b=>setTimeout(b,0x2ee0));action==='update'&&(killAllProcessesDuringUpdate||inDocker)&&(inDocker&&await setS6(H(0x13e)),logger[H(0x16b)](H(0x145)),await killAllProcesses(),logger['info'](H(0x181)));if(action==='update'){const b=toDeletePath+'/'+config['name']+'_'+Date[H(0x12c)](),c=await tryRename(launchExeDir,b);if(c){const d=appsDir+'/'+config[H(0x14e)]+H(0x17d),e=await tryRename(d,launchExeDir);e?(logger['info'](H(0x197)),await tryUnlink(b,0x1)):(logger[H(0x15f)](H(0x154)),await tryRename(b,launchExeDir),await tryUnlink(d,0x5));}}await runExe();}catch(f){logger[H(0x15f)](H(0x116)+JSON[H(0x174)](f)),inDocker&&(logger[H(0x15f)](H(0x123)),await setS6('up'));}await new Promise(g=>setTimeout(g,0x3e8)),process['exit'](0x0);};function a15b(a,b){const c=a15a();return a15b=function(d,e){d=d-0x112;let f=c[d];return f;},a15b(a,b);}void run();