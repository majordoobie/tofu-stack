x-common-env: &common-env
  PUID: 501
  PGID: 20
  TZ: America/New_York
networks:
  servarrnetwork:
    driver: bridge
services:
  # -----------------------------------------------------------------------------------
  # Traefik - Reverse Proxy with SSL
  # -----------------------------------------------------------------------------------
  traefik:
    image: traefik:v3.6
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "80:80"
      - "443:443"
      - "8888:8080"  # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./tofu-stack-secrets/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./tofu-stack-secrets:/etc/traefik/dynamic:ro
      - ./mounts/traefik/certs:/certs
      - ./mounts/traefik/logs:/var/log/traefik
    networks:
      - servarrnetwork
    labels:
      - "traefik.enable=true"
      # Traefik dashboard - local
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.home.arpa`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard-http.rule=Host(`traefik.home.arpa`)"
      - "traefik.http.routers.traefik-dashboard-http.entrypoints=web"
      - "traefik.http.routers.traefik-dashboard-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      # Traefik dashboard - Cloudflare tunnel
      - "traefik.http.routers.traefik-dashboard-cf.rule=Host(`traefik.majordoob.com`)"
      - "traefik.http.routers.traefik-dashboard-cf.entrypoints=web"
      - "traefik.http.routers.traefik-dashboard-cf.service=api@internal"
    environment:
      !!merge <<: *common-env
  # -----------------------------------------------------------------------------------
  ## VPN Tunnel service. This allows all the services that connect through the ports
  ## to be forwareded to the VPN server that the service is assigned to
  # -----------------------------------------------------------------------------------
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - 8000:8000 # gluetun built in web api
      - 8080:8080 # qbittorrent web interface
      - 6881:6881 # qbittorrent torrent port
      - 9696:9696 # prowlarr
      - 8191:8191 # flaresolverr
    volumes:
      - ./mounts/gluetun:/gluetun
      - ./tofu-stack-secrets/gluten_auth_config.toml:/gluetun/auth/config.toml:ro
    environment:
      VPN_SERVICE_PROVIDER: protonvpn
      VPN_TYPE: wireguard
      SERVER_COUNTRIES: Switzerland
      WIREGUARD_PRIVATE_KEY_SECRETFILE: /run/secrets/wireguard_private_key
    secrets:
      - wireguard_private_key
    networks:
      - servarrnetwork
    # Use built-in gluten VPN healthcheck (API key can only access status so yolo on showing it here)
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - --header='X-API-Key: YF8NrLvGG7RtWpCc1rF8YZ' http://localhost:8000/v1/publicip/ip | grep -q '\"country\":\"Switzerland\"'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    labels:
      - "traefik.enable=true"
      # qBittorrent routing - local (network_mode: service:gluetun)
      - "traefik.http.routers.qbittorrent.rule=Host(`qbittorrent.home.arpa`)"
      - "traefik.http.routers.qbittorrent.entrypoints=websecure"
      - "traefik.http.routers.qbittorrent.tls=true"
      - "traefik.http.routers.qbittorrent.service=qbittorrent"
      - "traefik.http.services.qbittorrent.loadbalancer.server.port=8080"
      - "traefik.http.routers.qbittorrent-http.rule=Host(`qbittorrent.home.arpa`)"
      - "traefik.http.routers.qbittorrent-http.entrypoints=web"
      - "traefik.http.routers.qbittorrent-http.middlewares=redirect-to-https"
      - "traefik.http.routers.qbittorrent-http.service=qbittorrent"
      # qBittorrent routing - Cloudflare tunnel
      - "traefik.http.routers.qbittorrent-cf.rule=Host(`qbittorrent.majordoob.com`)"
      - "traefik.http.routers.qbittorrent-cf.entrypoints=web"
      - "traefik.http.routers.qbittorrent-cf.service=qbittorrent"
      # Prowlarr routing - local (network_mode: service:gluetun)
      - "traefik.http.routers.prowlarr.rule=Host(`prowlarr.home.arpa`)"
      - "traefik.http.routers.prowlarr.entrypoints=websecure"
      - "traefik.http.routers.prowlarr.tls=true"
      - "traefik.http.routers.prowlarr.service=prowlarr"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"
      - "traefik.http.routers.prowlarr-http.rule=Host(`prowlarr.home.arpa`)"
      - "traefik.http.routers.prowlarr-http.entrypoints=web"
      - "traefik.http.routers.prowlarr-http.middlewares=redirect-to-https"
      - "traefik.http.routers.prowlarr-http.service=prowlarr"
      # Prowlarr routing - Cloudflare tunnel
      - "traefik.http.routers.prowlarr-cf.rule=Host(`prowlarr.majordoob.com`)"
      - "traefik.http.routers.prowlarr-cf.entrypoints=web"
      - "traefik.http.routers.prowlarr-cf.service=prowlarr"
    restart: unless-stopped
  # -----------------------------------------------------------------------------------
  ## qbittorrent is a torrent downloader. It is currently set to use the network stack
  ## of gluetun; meaning that it will be under the VPN when downloading
  # -----------------------------------------------------------------------------------
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    environment:
      !!merge <<: *common-env
      WEBUI_PORT: 8080
      TORRENTING_PORT: 6881
    volumes:
      - ./mounts/qbittorrent/appdata:/config
      - ./tofu-stack-secrets/qBittorrent.conf:/config/qBittorrent/qBittorrent.conf
      - /Volumes/Plex-Storage/media/:/data
    network_mode: "service:gluetun" # Routes ALL traffic through gluetun (Traefik labels are on gluetun service)
    depends_on:
      gluetun:
        condition: service_healthy
    healthcheck:
      test: ping -c 1 www.google.com || exit 1
      interval: 60s
      retries: 3
      start_period: 20s
      timeout: 10s
    restart: unless-stopped

  # -----------------------------------------------------------------------------------
    # Client to subscribe to usenet sources
  # -----------------------------------------------------------------------------------

  nzbget:
    image: lscr.io/linuxserver/nzbget:latest
    container_name: nzbget
    environment:
      FILE__NZBGET_USER: /run/secrets/nzbget_user
      FILE__NZBGET_PASS: /run/secrets/nzbget_pass
      !!merge <<: *common-env
    secrets:
      - nzbget_user
      - nzbget_pass
    volumes:
      - ./mounts/nzbget/appdata:/config
      - /Volumes/Plex-Storage/media/:/data
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      # nzbget - local
      - "traefik.http.routers.nzbget.rule=Host(`nzbget.home.arpa`)"
      - "traefik.http.routers.nzbget.entrypoints=websecure"
      - "traefik.http.routers.nzbget.tls=true"
      - "traefik.http.services.nzbget.loadbalancer.server.port=6789"
      - "traefik.http.routers.nzbget-http.rule=Host(`nzbget.home.arpa`)"
      - "traefik.http.routers.nzbget-http.entrypoints=web"
      # nzbget - Cloudflare tunnel
      - "traefik.http.routers.nzbget-cf.rule=Host(`nzbget.majordoob.com`)"
      - "traefik.http.routers.nzbget-cf.entrypoints=web"
      - "traefik.http.routers.nzbget-cf.service=nzbget"
    ports:
      - 6789:6789
    networks:
      - servarrnetwork

  # -----------------------------------------------------------------------------------
  ## the next thing to set up are the *arr apps
  #
  # -----------------------------------------------------------------------------------
  ## Set up the torrent indexer. This will index where to find the torrents.
  ## Tools like Raddarr will then pass matches from prowlarr to qbittorrent
  # -----------------------------------------------------------------------------------
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      !!merge <<: *common-env
    volumes:
      - ./mounts/prowlarr:/config
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    network_mode: service:gluetun  # Routes through gluetun (Traefik labels are on gluetun service)
  # -----------------------------------------------------------------------------------
  # Setup sonarr used to manage TV shows and submit the torrent to qbittoreent
  # -----------------------------------------------------------------------------------
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    environment:
      !!merge <<: *common-env
    volumes:
      - ./mounts/sonarr:/config
      - /Volumes/Plex-Storage/media/:/data
    labels:
      - "traefik.enable=true"
      # sonarr - local
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.home.arpa`)"
      - "traefik.http.routers.sonarr.entrypoints=websecure"
      - "traefik.http.routers.sonarr.tls=true"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"
      - "traefik.http.routers.sonarr-http.rule=Host(`sonarr.home.arpa`)"
      - "traefik.http.routers.sonarr-http.entrypoints=web"
      # sonarr - Cloudflare tunnel
      - "traefik.http.routers.sonarr-cf.rule=Host(`sonarr.majordoob.com`)"
      - "traefik.http.routers.sonarr-cf.entrypoints=web"
      - "traefik.http.routers.sonarr-cf.service=sonarr"
    ports:
      - 8989:8989
    networks:
      - servarrnetwork
    depends_on:
      gluetun:
        condition: service_healthy
  # -----------------------------------------------------------------------------------
  # Setup sonarr used to manage movies and submit the torrent to qbittoreent
  # -----------------------------------------------------------------------------------
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    environment:
      !!merge <<: *common-env
    volumes:
      - ./mounts/radarr:/config
      - /Volumes/Plex-Storage/media/:/data
    labels:
      - "traefik.enable=true"
      # radarr - local
      - "traefik.http.routers.radarr.rule=Host(`radarr.home.arpa`)"
      - "traefik.http.routers.radarr.entrypoints=websecure"
      - "traefik.http.routers.radarr.tls=true"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"
      - "traefik.http.routers.radarr-http.rule=Host(`radarr.home.arpa`)"
      - "traefik.http.routers.radarr-http.entrypoints=web"
      # radarr - Cloudflare tunnel
      - "traefik.http.routers.radarr-cf.rule=Host(`radarr.majordoob.com`)"
      - "traefik.http.routers.radarr-cf.entrypoints=web"
      - "traefik.http.routers.radarr-cf.service=radarr"
    ports:
      - 7878:7878
    networks:
      - servarrnetwork
    depends_on:
      gluetun:
        condition: service_healthy
  # -----------------------------------------------------------------------------------
  # Plex Media Server
  # -----------------------------------------------------------------------------------
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    restart: unless-stopped
    environment:
      !!merge <<: *common-env
      VERSION: docker
      PLEX_CLAIM: claim-oQzCXB2LJEr-P8oDoE3-
    volumes:
      - ./mounts/plex:/config
      - /Volumes/Plex-Storage/media/movies/:/movies
      - /Volumes/Plex-Storage/media/shows/:/tv
    ports:
      - 32400:32400
    networks:
      - servarrnetwork
    labels:
      - "traefik.enable=true"
      # plex - local
      - "traefik.http.routers.plex.rule=Host(`plex.home.arpa`)"
      - "traefik.http.routers.plex.entrypoints=websecure"
      - "traefik.http.routers.plex.tls=true"
      - "traefik.http.services.plex.loadbalancer.server.port=32400"
      - "traefik.http.routers.plex-http.rule=Host(`plex.home.arpa`)"
      - "traefik.http.routers.plex-http.entrypoints=web"
      # plex - Cloudflare tunnel
      - "traefik.http.routers.plex-cf.rule=Host(`plex.majordoob.com`)"
      - "traefik.http.routers.plex-cf.entrypoints=web"
      - "traefik.http.routers.plex-cf.service=plex"
  # -----------------------------------------------------------------------------------
  # Cloudflare Tunnel - Secure external access without port forwarding
  # -----------------------------------------------------------------------------------
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run --token-file /run/secrets/tunnel_token
    secrets:
      - tunnel_token
    networks:
      - servarrnetwork
    depends_on:
      - traefik
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # -----------------------------------------------------------------------------------
  # FlareSolverr - Bypasses Cloudflare protection for indexers
  # -----------------------------------------------------------------------------------
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      !!merge <<: *common-env
    network_mode: service:gluetun
    depends_on:
      gluetun:
        condition: service_healthy
    restart: unless-stopped
secrets:
  wireguard_private_key:
    file: tofu-stack-secrets/wireguard_private_key.txt
  nzbget_pass:
    file: tofu-stack-secrets/nzbget_pass.txt
  nzbget_user:
    file: tofu-stack-secrets/nzbget_user.txt
  tunnel_token:
    file: tofu-stack-secrets/cloudflare_tunnel_key.txt
