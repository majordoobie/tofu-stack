x-common-env: &common-env
  PUID: 501
  PGID: 20
  TZ: America/New_York
networks:
  servarrnetwork:
    driver: bridge
services:
  # -----------------------------------------------------------------------------------
  # Autoheal - Restarts unhealthy containers
  # -----------------------------------------------------------------------------------
  autoheal:
    image: willfarrell/autoheal
    container_name: autoheal
    restart: unless-stopped
    environment:
      AUTOHEAL_CONTAINER_LABEL: autoheal
      AUTOHEAL_INTERVAL: 60
      AUTOHEAL_START_PERIOD: 300
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
  # -----------------------------------------------------------------------------------
  # Traefik - Reverse Proxy with SSL
  # -----------------------------------------------------------------------------------
  traefik:
    image: traefik
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "80:80"
      - "443:443"
      - "8888:8080" # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./tofu-stack-secrets/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./tofu-stack-secrets:/etc/traefik/dynamic:ro
      - ./mounts/traefik/certs:/certs
      - ./mounts/traefik/logs:/var/log/traefik
    networks:
      - servarrnetwork
    labels:
      - "traefik.enable=true"
      # Traefik dashboard - local
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.home.arpa`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard-http.rule=Host(`traefik.home.arpa`)"
      - "traefik.http.routers.traefik-dashboard-http.entrypoints=web"
      - "traefik.http.routers.traefik-dashboard-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      # Traefik dashboard - Cloudflare tunnel
      - "traefik.http.routers.traefik-dashboard-cf.rule=Host(`traefik.majordoob.com`)"
      - "traefik.http.routers.traefik-dashboard-cf.entrypoints=web"
      - "traefik.http.routers.traefik-dashboard-cf.service=api@internal"
    environment:
      !!merge <<: *common-env
  # -----------------------------------------------------------------------------------
  ## VPN Tunnel service. This allows all the services that connect through the ports
  ## to be forwareded to the VPN server that the service is assigned to
  # -----------------------------------------------------------------------------------
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - 8000:8000 # gluetun built in web api
      - 8080:8080 # qbittorrent web interface
      - 6881:6881 # qbittorrent torrent port
      - 8118:8888 # HTTP proxy for prowlarr indexers (privoxy standard port)
    volumes:
      - ./mounts/gluetun:/gluetun
      - ./tofu-stack-secrets/gluten_auth_config.toml:/gluetun/auth/config.toml:ro
    environment:
      VPN_SERVICE_PROVIDER: protonvpn
      VPN_TYPE: openvpn
      SERVER_COUNTRIES: United States
      OPENVPN_USER_SECRETFILE: /run/secrets/openvpn_user
      OPENVPN_PASSWORD_SECRETFILE: /run/secrets/openvpn_pass
      HTTPPROXY: on
      HTTPPROXY_LISTENING_ADDRESS: :8888
    secrets:
      - openvpn_user
      - openvpn_pass
    networks:
      - servarrnetwork
    # Healthcheck tests actual VPN connectivity, not just cached API response
    # Sends 5 pings and requires 0% packet loss to detect unstable connections
    healthcheck:
      test: ["CMD-SHELL", "ping -c 5 -W 2 8.8.8.8 | grep -q '0% packet loss'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "autoheal=true"
      - "traefik.enable=true"
      # qBittorrent routing - local (network_mode: service:gluetun)
      - "traefik.http.routers.qbittorrent.rule=Host(`qbittorrent.home.arpa`)"
      - "traefik.http.routers.qbittorrent.entrypoints=websecure"
      - "traefik.http.routers.qbittorrent.tls=true"
      - "traefik.http.routers.qbittorrent.service=qbittorrent"
      - "traefik.http.services.qbittorrent.loadbalancer.server.port=8080"
      - "traefik.http.routers.qbittorrent-http.rule=Host(`qbittorrent.home.arpa`)"
      - "traefik.http.routers.qbittorrent-http.entrypoints=web"
      - "traefik.http.routers.qbittorrent-http.middlewares=redirect-to-https"
      - "traefik.http.routers.qbittorrent-http.service=qbittorrent"
      # qBittorrent routing - Cloudflare tunnel
      - "traefik.http.routers.qbittorrent-cf.rule=Host(`qbittorrent.majordoob.com`)"
      - "traefik.http.routers.qbittorrent-cf.entrypoints=web"
      - "traefik.http.routers.qbittorrent-cf.service=qbittorrent"
    restart: unless-stopped
  # -----------------------------------------------------------------------------------
  ## qbittorrent is a torrent downloader. It is currently set to use the network stack
  ## of gluetun; meaning that it will be under the VPN when downloading
  # -----------------------------------------------------------------------------------
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    cpus: 1
    environment:
      !!merge <<: *common-env
      WEBUI_PORT: 8080
      TORRENTING_PORT: 6881
    volumes:
      - ./mounts/qbittorrent/appdata:/config
      - ./tofu-stack-secrets/qBittorrent.conf:/config/qBittorrent/qBittorrent.conf
      - /Volumes/Working-Storage/downloads/torrents/:/data/torrents
    network_mode: "service:gluetun" # Routes ALL traffic through gluetun (Traefik labels are on gluetun service)
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    healthcheck:
      test: ping -c 1 www.google.com || exit 1
      interval: 60s
      retries: 3
      start_period: 20s
      timeout: 10s
    labels:
      - "autoheal=true"
    restart: unless-stopped
  # -----------------------------------------------------------------------------------
  # SABnzbd - Usenet downloader (replaced NZBGet due to SSL connection issues)
  # -----------------------------------------------------------------------------------
  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    cpus: 5
    environment:
      !!merge <<: *common-env
    volumes:
      - ./mounts/sabnzbd:/config
      - /Volumes/Working-Storage/downloads/usenet/:/data/usenet
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 curl -f http://localhost:8080 || exit 1"]
      interval: 60s
      retries: 3
      start_period: 30s
      timeout: 10s
    labels:
      - "traefik.enable=true"
      # sabnzbd - local
      - "traefik.http.routers.sabnzbd.rule=Host(`sabnzbd.home.arpa`)"
      - "traefik.http.routers.sabnzbd.entrypoints=websecure"
      - "traefik.http.routers.sabnzbd.tls=true"
      - "traefik.http.services.sabnzbd.loadbalancer.server.port=8080"
      - "traefik.http.routers.sabnzbd-http.rule=Host(`sabnzbd.home.arpa`)"
      - "traefik.http.routers.sabnzbd-http.entrypoints=web"
      - "traefik.http.routers.sabnzbd-http.middlewares=redirect-to-https"
    ports:
      - 8085:8080
    networks:
      - servarrnetwork
  # -----------------------------------------------------------------------------------
  ## Set up the torrent indexer. This will index where to find the torrents.
  ## Tools like Raddarr will then pass matches from prowlarr to qbittorrent
  # -----------------------------------------------------------------------------------
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      !!merge <<: *common-env
    volumes:
      - ./mounts/prowlarr:/config
    restart: unless-stopped
    ports:
      - 9696:9696
    networks:
      - servarrnetwork
    healthcheck:
      test: ["CMD", "ping", "-c", "1", "8.8.8.8"]
      interval: 60s
      retries: 3
      start_period: 20s
      timeout: 10s
    labels:
      - "autoheal=true"
      - "traefik.enable=true"
      # Prowlarr routing - local
      - "traefik.http.routers.prowlarr.rule=Host(`prowlarr.home.arpa`)"
      - "traefik.http.routers.prowlarr.entrypoints=websecure"
      - "traefik.http.routers.prowlarr.tls=true"
      - "traefik.http.routers.prowlarr.service=prowlarr"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"
      - "traefik.http.routers.prowlarr-http.rule=Host(`prowlarr.home.arpa`)"
      - "traefik.http.routers.prowlarr-http.entrypoints=web"
      - "traefik.http.routers.prowlarr-http.middlewares=redirect-to-https"
      - "traefik.http.routers.prowlarr-http.service=prowlarr"
      # Prowlarr routing - Cloudflare tunnel
      - "traefik.http.routers.prowlarr-cf.rule=Host(`prowlarr.majordoob.com`)"
      - "traefik.http.routers.prowlarr-cf.entrypoints=web"
      - "traefik.http.routers.prowlarr-cf.service=prowlarr"
  # -----------------------------------------------------------------------------------
  # Setup sonarr used to manage TV shows and submit the torrent to qbittoreent
  # -----------------------------------------------------------------------------------
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    environment:
      !!merge <<: *common-env
    volumes:
      - ./mounts/sonarr:/config
      - /Volumes/Working-Storage/downloads:/data # SSD
      - /Volumes/Plex-Storage/media/:/media_files  # HHD
    labels:
      - "traefik.enable=true"
      # sonarr - local
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.home.arpa`)"
      - "traefik.http.routers.sonarr.entrypoints=websecure"
      - "traefik.http.routers.sonarr.tls=true"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"
      - "traefik.http.routers.sonarr-http.rule=Host(`sonarr.home.arpa`)"
      - "traefik.http.routers.sonarr-http.entrypoints=web"
      # sonarr - Cloudflare tunnel
      - "traefik.http.routers.sonarr-cf.rule=Host(`sonarr.majordoob.com`)"
      - "traefik.http.routers.sonarr-cf.entrypoints=web"
      - "traefik.http.routers.sonarr-cf.service=sonarr"
    ports:
      - 8989:8989
    networks:
      - servarrnetwork
  # -----------------------------------------------------------------------------------
  # Setup sonarr used to manage movies and submit the torrent to qbittoreent
  # -----------------------------------------------------------------------------------
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    environment:
      !!merge <<: *common-env
    volumes:
      - ./mounts/radarr:/config
      - /Volumes/Working-Storage/downloads:/data # SSD
      - /Volumes/Plex-Storage/media/:/media_files  # HHD
    labels:
      - "traefik.enable=true"
      # radarr - local
      - "traefik.http.routers.radarr.rule=Host(`radarr.home.arpa`)"
      - "traefik.http.routers.radarr.entrypoints=websecure"
      - "traefik.http.routers.radarr.tls=true"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"
      - "traefik.http.routers.radarr-http.rule=Host(`radarr.home.arpa`)"
      - "traefik.http.routers.radarr-http.entrypoints=web"
      # radarr - Cloudflare tunnel
      - "traefik.http.routers.radarr-cf.rule=Host(`radarr.majordoob.com`)"
      - "traefik.http.routers.radarr-cf.entrypoints=web"
      - "traefik.http.routers.radarr-cf.service=radarr"
    ports:
      - 7878:7878
    networks:
      - servarrnetwork
  # -----------------------------------------------------------------------------------
  # Jellyfin Media Server - runs natively on macOS (not in Docker)
  # Traefik routing configured in traefik-dynamic.yml
  # -----------------------------------------------------------------------------------
  # -----------------------------------------------------------------------------------
  # Cloudflare Tunnel - Secure external access without port forwarding
  # -----------------------------------------------------------------------------------
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run --token-file /run/secrets/tunnel_token
    secrets:
      - tunnel_token
    networks:
      - servarrnetwork
    depends_on:
      - traefik
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "ready", "--metrics", "localhost:20241"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  # -----------------------------------------------------------------------------------
  # Tdarr - Automated media transcoding (adds AAC audio tracks for HomePod compatibility)
  # -----------------------------------------------------------------------------------
  # tdarr:
  #   image: ghcr.io/haveagitgat/tdarr:latest
  #   container_name: tdarr
  #   cpus: 2
  #   restart: unless-stopped
  #   environment:
  #     !!merge <<: *common-env
  #     serverIP: 0.0.0.0
  #     serverPort: 8266
  #     webUIPort: 8265
  #     internalNode: "false"
  #     inContainer: "true"
  #     ffmpegVersion: 7
  #     nodeName: InternalNode
  #   volumes:
  #     - ./mounts/tdarr/server:/app/server
  #     - ./mounts/tdarr/configs:/app/configs
  #     - ./mounts/tdarr/logs:/app/logs
  #     - /Volumes/Plex-Storage/media:/data_files
  #     - /Volumes/Working-Storage/tdarr_cache:/temp # SSD - transcode cache
  #   ports:
  #     - 8265:8265 # Web UI
  #     - 8266:8266 # Server port
  #   networks:
  #     - servarrnetwork
  #   labels:
  #     - "traefik.enable=true"
  #     # tdarr - local
  #     - "traefik.http.routers.tdarr.rule=Host(`tdarr.home.arpa`)"
  #     - "traefik.http.routers.tdarr.entrypoints=websecure"
  #     - "traefik.http.routers.tdarr.tls=true"
  #     - "traefik.http.services.tdarr.loadbalancer.server.port=8265"
  #     - "traefik.http.routers.tdarr-http.rule=Host(`tdarr.home.arpa`)"
  #     - "traefik.http.routers.tdarr-http.entrypoints=web"
  #     - "traefik.http.routers.tdarr-http.middlewares=redirect-to-https"
  # -----------------------------------------------------------------------------------
  # Tautulli - Plex monitoring and statistics
  # -----------------------------------------------------------------------------------
  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    container_name: tautulli
    restart: unless-stopped
    environment:
      !!merge <<: *common-env
    volumes:
      - ./mounts/tautulli:/config
    ports:
      - 8181:8181
    networks:
      - servarrnetwork
    labels:
      - "traefik.enable=true"
      # tautulli - local
      - "traefik.http.routers.tautulli.rule=Host(`tautulli.home.arpa`)"
      - "traefik.http.routers.tautulli.entrypoints=websecure"
      - "traefik.http.routers.tautulli.tls=true"
      - "traefik.http.services.tautulli.loadbalancer.server.port=8181"
      - "traefik.http.routers.tautulli-http.rule=Host(`tautulli.home.arpa`)"
      - "traefik.http.routers.tautulli-http.entrypoints=web"
      - "traefik.http.routers.tautulli-http.middlewares=redirect-to-https"
  # -----------------------------------------------------------------------------------
  # overseerr - media request management for plex
  # -----------------------------------------------------------------------------------
  overseerr:
    image: lscr.io/linuxserver/overseerr:latest
    container_name: overseerr
    restart: unless-stopped
    environment:
      !!merge <<: *common-env
    volumes:
      - ./mounts/overseerr:/config
    ports:
      - 5055:5055
    networks:
      - servarrnetwork
    labels:
      - "traefik.enable=true"
      # overseerr - Cloudflare tunnel
      - "traefik.http.routers.overseerr-cf.rule=Host(`overseerr.majordoob.com`)"
      - "traefik.http.routers.overseerr-cf.entrypoints=web"
      - "traefik.http.routers.overseerr-cf.service=overseerr"
      - "traefik.http.services.overseerr.loadbalancer.server.port=5055"
  # -----------------------------------------------------------------------------------
  # homepage
  # -----------------------------------------------------------------------------------
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    environment:
      !!merge <<: *common-env
      HOMEPAGE_ALLOWED_HOSTS: 192.168.1.2:3000,homepage.majordoob.com
    ports:
      - 3000:3000
    volumes:
      - ./mounts/homepage/:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - "traefik.enable=true"
      # homepage - Cloudflare tunnel
      - "traefik.http.routers.homepage-cf.rule=Host(`homepage.majordoob.com`)"
      - "traefik.http.routers.homepage-cf.entrypoints=web"
      - "traefik.http.routers.homepage-cf.service=homepage"
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"
  # -----------------------------------------------------------------------------------
  # Ofelia - Docker Job Scheduler (runs Recyclarr sync daily)
  # -----------------------------------------------------------------------------------
  ofelia:
    image: mcuadros/ofelia:latest
    container_name: ofelia
    restart: unless-stopped
    depends_on:
      - recyclarr
    command: daemon --docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - "ofelia.enabled=true"
  # -----------------------------------------------------------------------------------
  # Recyclarr - Syncs TRaSH Guides to Radarr/Sonarr
  # -----------------------------------------------------------------------------------
  recyclarr:
    image: ghcr.io/recyclarr/recyclarr:latest
    container_name: recyclarr
    restart: unless-stopped
    user: 501:20
    environment:
      TZ: America/New_York
    volumes:
      - ./mounts/recyclarr:/config
    networks:
      - servarrnetwork
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.recyclarr-sync.schedule=0 0 3 * * *"
      - "ofelia.job-exec.recyclarr-sync.command=recyclarr sync"
secrets:
  openvpn_user:
    file: tofu-stack-secrets/openvpn_user.txt
  openvpn_pass:
    file: tofu-stack-secrets/openvpn_pass.txt
  nzbget_pass:
    file: tofu-stack-secrets/nzbget_pass.txt
  nzbget_user:
    file: tofu-stack-secrets/nzbget_user.txt
  tunnel_token:
    file: tofu-stack-secrets/cloudflare_tunnel_key.txt
